Resumo do Sistema

Visão geral
- Sistema Laravel para gestão de almoxarifado militar: produtos, inventário, seções, transferências, cautelas (empréstimos), movimentações.
- Autenticação e autorização de acesso por nível

Modelos principais (resumo de campos e relações)
1) Produto (table: produtos)
   - Campos relevantes: id, nome, descricao, marca, valor, fk_categoria, tamanho, unidade, ativo, patrimonio, tipo_controle
   - tipo_controle: enum('consumo', 'permanente') - define se é bem de consumo ou patrimonial
   - Relações: categoria() -> Categoria via fk_categoria
               kit() -> Kit via fk_kit
               tamanho() -> Tamanho
               itensEstoque() -> Itens_estoque (para consumíveis)
               itensPatrimoniais() -> ItenPatrimonial (para bens permanentes)

2) Itens_estoque (table: itens_estoque) - BENS DE CONSUMO
   - Campos: id, quantidade, quantidade_cautelada, preco_unitario, unidade (id), fk_secao, data_entrada, data_saida, fk_produto, lote, fornecedor, nota_fiscal, observacao, fonte
   - Relações: secao() -> Secao via fk_secao
               produto() -> Produto via fk_produto (tipo_controle = 'consumo')
               unidade() -> Unidade
   - Negócio: quantidade_cautelada rastreia itens emprestados; quantidade é agregada (ex: 100 luvas)

3) ItenPatrimonial (table: itens_patrimoniais) - BENS PERMANENTES
   - Campos: id, fk_produto, patrimonio (unique), serie, fk_secao, condicao, data_entrada, data_saida, quantidade_cautelada, observacao, timestamps
   - Relações: produto() -> Produto via fk_produto (tipo_controle = 'permanente')
               secao() -> Secao via fk_secao
   - Negócio: cada registro = um bem único e numerado; patrimonio é obrigatório e único; quantidade sempre 1

3) Secao (table: secaos)
   - Campos: id, nome, fk_unidade
   - Relação: unidade()

4) Cautela (table: cautelas) e CautelaProduto (table: cautela_produto)
   - Cautela: nome_responsavel, telefone, instituicao, data_cautela, data_prevista_devolucao, data_devolucao, etc.
   - CautelaProduto: cautela_id, produto_id, quantidade

5) Unidade, Categoria, Kit, Tamanho, Condicao, etc. (modelos auxiliares existentes)

Controladores e endpoints (principais)
- ProdutoController
  - formInserirProduto() -> GET /produtos/inserir (view com tipo_controle e campos dinâmicos)
    * Mostra radio buttons: Consumo vs Permanente
    * Se Permanente: mostra formulário dinâmico para N patrimônios (add/remove bens)
    * Cada bem requer: patrimônio (obrigatório, único), série (opcional), condição
  - cadastrarProduto(Request) -> POST /produtos/cadastrar
    * Valida tipo_controle
    * Se tipo='consumo': cria Produto normal
    * Se tipo='permanente': cria Produto + N registros em itens_patrimoniais (um por patrimônio informado)
    * Valida unicidade de patrimônios (não pode repetir)
  - ... outros métodos existentes
  - getDetalhesPorSecao($id) -> GET /api/produtos/{id}/detalhes-secao (JSON)
  - detalhes($id) -> GET /estoque/produto/{id}/detalhes (view com quebra por seção)
  - createEstoque(), storeEstoque() -> criar produto + entrada em estoque
  - editarProdutoForm, editarProduto/update

- EstoqueController
  - listarEstoque(Request) -> GET /registros/estoque/listar (agrupa por produto e soma quantidades)
  - entradaEstoque / entradaProdutoEstoque / saidaEstoque / formEntrada / formSaida
  - transferir(Request) -> POST /estoque/transferencia (transferência entre unidades)
  - saidaMultiplos(Request) -> POST /estoque/saida-multiplos
  - recibo($saida) -> /estoque/recibo/{saida}

- SecaoController
  - ver($unidadeId, $secaoId) -> view da seção
  - transferirLoteForm / transferirLote / transferirItens -> transferências entre seções
  - getItems(Secao $secao) -> GET /api/secoes/{secao}/items (retorna itens disponíveis na seção)
  - vincularItensForm / vincularItens -> vincular itens "soltos" a uma seção

- CautelaController
  - create() -> GET form de cautela (view: cautelas.create)
  - store(Request) -> POST salvar cautela e itens (cautela_produto)
    * Incrementa quantidade_cautelada em itens_estoque para cada item cautelado
    * Decrementa quantidade (disponível) em itens_estoque
  - processDevolucao(Request) -> POST processar devolução de cautela
    * Decrementa quantidade_cautelada quando itens são devolvidos
    * Incrementa quantidade (disponível) em itens_estoque
  - previewPDF($cautela) -> GET /cautelas/{cautela}/preview (preview HTML)
  - gerarPDF($cautela) -> GET /cautelas/{cautela}/pdf (gera PDF via DOMPDF)

- InventarioController
  - form() -> GET /inventario/cadastrar (view inventario.form)
  - salvar(Request) -> POST /inventario/salvar (cria produto e opcionalmente cria registro em itens_estoque se informada secao+quantidade)

Rotas API (AJAX)
- GET /api/secoes/{secao}/items -> retorna items disponíveis na seção
  - Response: [{ id, nome, quantidade, ... }]
- GET /api/produtos/{id}/detalhes-secao -> retorna agregação por seção
  - Response: [{ secao_id, secao_nome, quantidade }, ...]

Rotas de Cautela
- GET /cautelas/create -> formulário para criar cautela
- POST /cautelas -> salvar cautela com produtos
- GET /cautelas/{cautela}/show -> detalhes da cautela
- POST /cautelas/{cautela}/devolucao -> processar devolução
- GET /cautelas/{cautela}/preview -> preview HTML do comprovante
- GET /cautelas/{cautela}/pdf -> gerar/download PDF do comprovante

Fluxos importantes
1) Cadastro com tipo de controle
   - Usuario seleciona tipo: Consumo ou Permanente
   
   A) Tipo CONSUMO:
      - Cadastra produto com tipo_controle='consumo'
      - Itens controlados em itens_estoque com quantidade agregada
      - Exemplo: 100 luvas, 500 pilhas
      - Para adicionar quantidade, usa "Registrar Entrada" (incrementa quantidade em itens_estoque)
   
   B) Tipo PERMANENTE (Patrimonial):
      - Cadastra produto com tipo_controle='permanente'
      - Sistema obriga preenchimento de patrimônios individuais (num único por bem)
      - Cria N registros em itens_patrimoniais (um por bem numerado)
      - Exemplo: Rádio HT com patrimônios 0001, 0002, 0003 (cria 3 registros)
      - Cada bem tem série (opcional), condição, seção, datas
      - Número de itens = quantidade de patrimônios informados

2) Transferência entre seções/unidades
   - Deduz do registro origem (itens_estoque.quantidade -= qtd)
   - Se item igual (mesmo fk_produto e lote) existir na seção destino: incrementa quantidade; caso contrário réplicate() para criar novo registro com fk_secao destino e quantidade transferida

3) Cautela (empréstimo) com rastreamento automático
   - Form permite selecionar seção -> carregar itens via AJAX -> selecionar item e quantidade
   - Ao salvar:
     * Cria Cautela com responsavel_unidade = nome do usuário logado (Auth::user()->nome)
     * Registra itens em cautela_produto
     * Incrementa quantidade_cautelada em itens_estoque (marca como emprestado)
     * Decrementa quantidade em itens_estoque (reduz quantidade disponível)
   - Ao processar devolução (partial ou total):
     * Decrementa quantidade_cautelada
     * Incrementa quantidade (resgata para disponível)
     * Registra quantidade_devolvida em cautela_produto
     * Atualiza data_devolucao quando 100% devolvido
   - NOTA: Cautelas para bens permanentes não foram implementadas no escopo atual

Views principais
- estoque/listarEstoque.blade.php: 
  * Seção 1: Bens de CONSUMO (itens_estoque)
    - Tabela agregada por produto com colunas:
      * Produto, Localização, Patrimônio
      * Quantidade (total em estoque)
      * Cautelado (itens emprestados via cautelas)
      * Disponível (quantidade - cautelado)
      * Unidade, Categoria, Estoque, Valor Médio, Subtotal, Transferência
    - Linha clicável abre página de detalhes por seção
  
  * Seção 2: Bens PATRIMONIAIS (itens_patrimoniais)
    - Tabela com colunas:
      * Patrimônio (número único, em destaque), Produto, Série
      * Localização (seção), Condição (badge: novo/bom/regular/ruim)
      * Cautelado (sim/não), Entrada (data), Ações (detalhes/editar)
    - Cada linha = um bem individual
    - Indicadores visuais de condição e disponibilidade
    
- produtos/inserirProduto.blade.php: 
  * Adiciona tipos de controle com radio buttons
  * Seção dinâmica para bens patrimoniais (add/remove patrimônios)
  * JavaScript para mostrar/esconder campos baseado em tipo selecionado
  
- produtos/detalhes.blade.php: detalhe do produto com tabela quantidade por seção
- cautelas/create.blade.php: formulário dinâmico para emprestar múltiplos itens
- cautelas/comprovante-content.blade.php: conteúdo HTML reusável para PDF e preview
- cautelas/preview-comprovante.blade.php: visualização HTML do comprovante antes de gerar PDF
- cautelas/show.blade.php: detalhes da cautela com botões para preview e download do comprovante
- inventario/form.blade.php: formulário para cadastrar produto com opção de seção e quantidade inicial
- layout/aside.blade.php: menu lateral (contém listagem dinâmica de seções)

Seeds / dados iniciais
- SecaoSeeder: popula seções típicas (Armamento, Munição, Equipamento Individual, etc.) e cria 'Unidade Principal'

Observações técnicas e mapeamentos
- Campos FK: atenção a nomes não-padrão: produtos.fk_categoria (não categoria_id)
- Campo customizado: users.nome (não users.name) - importante para Auth::user()->nome
- Novo campo: produtos.tipo_controle (enum: 'consumo', 'permanente') - define fluxo de entrada
- Divisão de tabelas:
  * itens_estoque: APENAS para produtos tipo 'consumo' (quantidade agregada)
  * itens_patrimoniais: APENAS para produtos tipo 'permanente' (unidades individuais)
- Patrimônio:
  * Para consumo: opcional, armazenado em produtos.patrimonio (descrição geral)
  * Para permanente: OBRIGATÓRIO, ÚNICO, armazenado em itens_patrimoniais.patrimonio (número por bem)
- Transações: operações que envolvem múltiplas alterações (cadastrar produto permanente + criar N patrimoniais) utilizam DB transactions
- Validação server-side: presente em controllers
  * Consumo: valida quantidade >= disponível
  * Permanente: valida unicidade de patrimônios, valida que cada bem tem patrimônio
- Rastreamento de quantidade cautelada:
  * Campo em itens_patrimoniais.quantidade_cautelada (para futura integração com cautelas de bens)
  * CautelaController.store() incrementa quantidade_cautelada em itens_estoque (consumo)
  * CautelaController.processDevolucao() decrementa quantidade_cautelada em itens_estoque (consumo)
  * View listarEstoque exibe: Quantidade | Cautelado | Disponível (cálculo automático)
- PDF gerado via barryvdh/laravel-dompdf
- JS: jQuery usado para AJAX, clonagem de linhas (especialmente em formulário de patrimoniais), máscaras

Trechos de exemplo (payloads)
Cadastro de CONSUMO:
- POST /produtos/cadastrar (form)
  nome=Luva&tipo_controle=consumo&categoria=5&unidade=1

Cadastro de PERMANENTE:
- POST /produtos/cadastrar (form)
  nome=Rádio HT&tipo_controle=permanente&categoria=3
  patrimonios[0][patrimonio]=0001&patrimonios[0][condicao]=novo
  patrimonios[1][patrimonio]=0002&patrimonios[1][condicao]=novo
  patrimonios[2][patrimonio]=0003&patrimonios[2][condicao]=novo

Resultado:
- Cria 1 Produto com tipo_controle='permanente'
- Cria 3 registros em itens_patrimoniais (um por patrimônio)

Próximos passos sugeridos
- Implementar cautelas para bens patrimoniais (atualmente apenas consumo)
- Adicionar detalhes/edição de bens patrimoniais individuais
- Implementar histórico de movimentação de bens patrimoniais
- Gerar relatórios por tipo de bem (consumo vs permanente)
- Integração com cautelas de bens permanentes para rastreamento de localização em tempo real

Local do arquivo gerado neste workspace:
c:\laragon\www\sisalmox\system_export\sistema_resumo.txt

Próximos passos sugeridos
- Gerar OpenAPI (YAML) com os endpoints JSON para importar em outra IA/plataforma
- Gerar ERD (lista de tabelas + campos) e migrations correspondentes
- Gerar scripts curl e exemplos de payload para testes automatizados

Fim do arquivo
